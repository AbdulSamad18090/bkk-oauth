<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <title>OAuth2 Client</title>
  </head>
  <body>
    <h2>Login via OAuth2</h2>
    <button id="login">Continue To Authorize</button>
    <p id="token"></p>
    <p id="refreshToken"></p>
    <p id="tokenByPassword"></p>

    <script>
      const authServer = "http://localhost:4000";
      const clientId = "test";
      const redirectUri = "http://localhost:5500/client/index.html";

      // Open popup
      document.getElementById("login").onclick = () => {
        const authUrl = `${authServer}/authorize?response_type=code&client_id=${clientId}&redirect_uri=${encodeURIComponent(
          redirectUri
        )}`;
        const width = 600;
        const height = 600;
        const left = (screen.width - width) / 2;
        const top = (screen.height - height) / 2;

        const popup = window.open(
          authUrl,
          "OAuthPopup",
          `width=${width},height=${height},top=${top},left=${left},resizable=no,scrollbars=yes`
        );

        if (popup) popup.focus();
      };

      // Receive OAuth code from popup
      window.addEventListener("message", async (event) => {
        if (event.data?.type === "OAUTH_COMPLETE" && event.data.fullUrl) {
          const fullUrl = new URL(event.data.fullUrl);
          console.log("Full URL ===>", fullUrl);
          const code = fullUrl.searchParams.get("code");

          if (code) {
            await generateAccessToken(code);
            await generateRefreshToken();
            await generateAccessTokenByPassword();
            window.location.href = fullUrl.href;
          }
        }
      });

      // Step 1: Exchange code for access token
      async function generateAccessToken(code) {
        const res = await fetch(`${authServer}/token`, {
          method: "POST",
          headers: {
            "Content-Type": "application/x-www-form-urlencoded",
            Authorization: "Basic " + btoa("test:test"),
          },
          body: new URLSearchParams({
            grant_type: "authorization_code",
            code,
            redirect_uri: redirectUri,
          }),
        });

        const data = await res.json();
        const { access_token: accessToken, refresh_token: refreshToken } = data;

        localStorage.setItem("accessToken", accessToken);
        localStorage.setItem("refreshToken", refreshToken);

        document.getElementById("token").innerText =
          "Access Token: " + accessToken;
      }

      // Step 2: Use refresh token to get new access token
      async function generateRefreshToken() {
        const refreshToken = localStorage.getItem("refreshToken");

        const res = await fetch(`${authServer}/token`, {
          method: "POST",
          headers: {
            "Content-Type": "application/x-www-form-urlencoded",
            Authorization: "Basic " + btoa("test:test"),
          },
          body: new URLSearchParams({
            grant_type: "refresh_token",
            refresh_token: refreshToken,
          }),
        });

        const data = await res.json();
        const { access_token, refresh_token } = data;

        localStorage.setItem("accessToken", access_token);
        localStorage.setItem("refreshToken", refresh_token);

        document.getElementById("refreshToken").innerText =
          "Refresh Token: " + refresh_token;
      }

      // Step 3: Use password grant (optional)
      async function generateAccessTokenByPassword() {
        const res = await fetch(`${authServer}/token`, {
          method: "POST",
          headers: {
            "Content-Type": "application/x-www-form-urlencoded",
            Authorization: "Basic " + btoa("test:test"),
          },
          body: new URLSearchParams({
            grant_type: "password",
            username: "admin",
            password: "admin",
          }),
        });

        const data = await res.json();
        const { access_token, refresh_token } = data;

        document.getElementById("tokenByPassword").innerText =
          "Access Token (Password Grant): " + access_token;
      }

      // === If in popup and code exists, return code to opener ===
      const params = new URLSearchParams(window.location.search);
      const popupCode = params.get("code");

      if (window.opener && popupCode) {
        window.opener.postMessage({ type: "OAUTH_CODE", code: popupCode }, "*");

        // document.body.innerHTML = `<p style="text-align:center;color:green;font-size:18px;">Authorization Successful</p>`;
        setTimeout(() => window.close(), 1000);
      }
    </script>
  </body>
</html>
